import requests
import pandas as pd
from tqdm import tqdm

# === CONFIGURA√á√ïES ===
ANO = 2024
ENTIDADE = "SENAI"

# Lista de siglas de todos os departamentos regionais
estados = [
    "SENAI-AC", "SENAI-AL", "SENAI-AM", "SENAI-AP", "SENAI-BA",
    "SENAI-CE", "SENAI-DF", "SENAI-ES", "SENAI-GO", "SENAI-MA",
    "SENAI-MG", "SENAI-MS", "SENAI-MT", "SENAI-PA", "SENAI-PB",
    "SENAI-PE", "SENAI-PI", "SENAI-PR", "SENAI-RJ", "SENAI-RN",
    "SENAI-RO", "SENAI-RR", "SENAI-RS", "SENAI-SC", "SENAI-SE",
    "SENAI-SP", "SENAI-TO"
]

# URL base da API
URL = "https://sistematransparenciaweb.com.br/api-gratuidade-resultados/publico/gratuidade/dr/senai/cumprimento-acordo"

# Lista para armazenar todos os DataFrames
dados_consolidados = []

print(f"üì° Baixando dados dos estados ({ANO})...")

for uf in tqdm(estados, desc="Baixando dados dos estados"):
    try:
        params = {
            "entidade": ENTIDADE,
            "departamento": uf,
            "ano": ANO
        }
        response = requests.get(URL, params=params, timeout=15)
        if response.status_code == 200:
            data = response.json()
            if data:
                # Se o retorno for um dicion√°rio, converte para lista
                if isinstance(data, dict):
                    data = [data]
                df_temp = pd.DataFrame(data)
                df_temp["UF"] = uf  # adiciona coluna identificando o estado
                dados_consolidados.append(df_temp)
        else:
            print(f"‚ö†Ô∏è Erro {response.status_code} ao buscar {uf}")
    except Exception as e:
        print(f"‚ùå Erro ao processar {uf}: {e}")

# Junta todos os DataFrames
if dados_consolidados:
    df_final = pd.concat(dados_consolidados, ignore_index=True)
    # Remove colunas vazias (opcional)
    df_final = df_final.dropna(axis=1, how="all")

    # Exporta para Excel
    arquivo_excel = f"resultado_gratuidade_senai_{ANO}.xlsx"
    df_final.to_excel(arquivo_excel, index=False)
    print(f"\n‚úÖ Arquivo salvo com sucesso: {arquivo_excel}")
    print(f"üìä Total de registros: {len(df_final)}")
else:
    print("‚ö†Ô∏è Nenhum dado retornado pela API. Pode n√£o haver resultados publicados para este ano.")
