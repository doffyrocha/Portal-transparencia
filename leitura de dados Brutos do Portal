import requests
import pandas as pd
import io

ano = 2024
sigla_nacional = "SENAI"
formato = "XLSX"
departamento_prefix = "SENAI"

estados = [
    "AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG",
    "PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO"
]

url_export = "https://sistematransparenciaweb.com.br/api-gratuidade/publico/gratuidades/vagas/export"

dfs = []

for uf in estados:
    params = {
        "ano": ano,
        "departamento": f"{departamento_prefix}-{uf}",
        "formatoExportacao": formato,
        "siglaEntidadeNacional": sigla_nacional
    }
    try:
        resp = requests.get(url_export, params=params, timeout=30)
        if resp.status_code == 404:
            print(f"Sem dados para {uf} (404).")
            continue
        resp.raise_for_status()

        # Lê direto o conteúdo XLSX da resposta em memória
        df = pd.read_excel(io.BytesIO(resp.content))
        df["UF"] = uf  # adiciona coluna de estado
        dfs.append(df)
        print(f"✅ Dados coletados para {uf}")

    except Exception as e:
        print(f"Erro ao buscar {uf}: {e}")

# Consolida tudo em um único Excel
if dfs:
    df_final = pd.concat(dfs, ignore_index=True)
    df_final.to_excel(f"gratuidade_{ano}_consolidado.xlsx", index=False)
    print(f"Arquivo 'gratuidade_{ano}_consolidado.xlsx' gerado com sucesso!")
else:
    print("Nenhum dado coletado.")
