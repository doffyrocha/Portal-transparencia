import requests
import pandas as pd
from tqdm import tqdm

# Lista de departamentos SESI (todos os estados)
departamentos = [
    "SESI-AC", "SESI-AL", "SESI-AM", "SESI-AP", "SESI-BA", "SESI-CE", "SESI-DF", "SESI-ES",
    "SESI-GO", "SESI-MA", "SESI-MG", "SESI-MS", "SESI-MT", "SESI-PA", "SESI-PB", "SESI-PE",
    "SESI-PI", "SESI-PR", "SESI-RJ", "SESI-RN", "SESI-RO", "SESI-RR", "SESI-RS", "SESI-SC",
    "SESI-SE", "SESI-SP", "SESI-TO"
]

anos = range(2021, 2026)
base_url = "https://sistematransparenciaweb.com.br/api-gratuidade-resultados/publico/gratuidade/modalidade/sesi/hora-aluno-total"

dados = []

print("üìä Iniciando extra√ß√£o: SESI - Hora-Aluno Total")

for dep in tqdm(departamentos, desc="Departamentos SESI"):
    for ano in anos:
        url = f"{base_url}?entidade=SESI&departamento={dep}&ano={ano}"
        try:
            r = requests.get(url, headers={"accept": "application/json"})
            texto = r.text.strip()
            # Mesmo se o status for 404, tentamos extrair o JSON
            if texto and "programas" in texto:
                data = r.json()
                for programa in data.get("programas", []):
                    for modalidade in programa.get("modalidades", []):
                        dados.append({
                            "ano": data.get("ano"),
                            "departamento": data.get("departamento"),
                            "programa": programa.get("nomePrograma"),
                            "modalidade": modalidade.get("nomeModalidade"),
                            "horaAlunoTotalRealizado": modalidade.get("horaAlunoTotalRealizado"),
                            "somaHoraAlunoTotalRealizado": data.get("somaHoraAlunoTotalRealizado"),
                            "fonte": data.get("fonte"),
                            "dataPublicacao": data.get("dataPublicacao"),
                            "categoria": data.get("categoria")
                        })
        except Exception as e:
            print(f"‚ö†Ô∏è Erro em {dep} - {ano}: {e}")

# Converter em DataFrame e exportar
df = pd.DataFrame(dados)
df.to_excel("SESI_Hora_Aluno_Total.xlsx", index=False)

print(f"‚úÖ Conclu√≠do! Linhas extra√≠das: {len(df)}")
print("üìÅ Arquivo salvo como: SESI_Hora_Aluno_Total.xlsx")
