import requests
import pandas as pd
from tqdm import tqdm

# ğŸ”¹ Lista de departamentos SENAI
departamentos = [
    "SENAI-AC", "SENAI-AL", "SENAI-AM", "SENAI-AP", "SENAI-BA", "SENAI-CE", "SENAI-DF", "SENAI-ES",
    "SENAI-GO", "SENAI-MA", "SENAI-MG", "SENAI-MS", "SENAI-MT", "SENAI-PA", "SENAI-PB", "SENAI-PE",
    "SENAI-PI", "SENAI-PR", "SENAI-RJ", "SENAI-RN", "SENAI-RO", "SENAI-RR", "SENAI-RS", "SENAI-SC",
    "SENAI-SE", "SENAI-SP", "SENAI-TO"
]

anos = range(2021, 2026)

# ğŸ”¹ Endpoint da API
base_url = "https://sistematransparenciaweb.com.br/api-gratuidade-resultados/publico/gratuidade/modalidade/senai/despesas-aplicadas-gratuidade-regimental"

# ğŸ”¹ Para armazenar os dados extraÃ­dos
dados = []

print("ğŸ“Š Iniciando extraÃ§Ã£o: SENAI - Despesas aplicadas em Gratuidade Regimental")

# ğŸ”¹ Loop pelos departamentos e anos
for dep in tqdm(departamentos, desc="Departamentos SENAI"):
    for ano in anos:
        url = f"{base_url}?entidade=SENAI&departamento={dep}&ano={ano}"

        try:
            r = requests.get(url, headers={"accept": "application/json"})

            # Ignorar respostas vazias
            if r.status_code != 200 or not r.text.strip():
                continue

            data = r.json()

            # ğŸ”¹ Programas e modalidades
            for programa in data.get("despesaProgramasModalidades", []):
                nome_programa = programa.get("nomePrograma")

                for modalidade in programa.get("modalidades", []):
                    dados.append({
                        "entidade": data.get("entidade"),
                        "departamento": data.get("departamento"),
                        "ano": data.get("ano"),

                        "programa": nome_programa,
                        "modalidade": modalidade.get("nomeModalidade"),

                        "ead": modalidade.get("ead"),
                        "presencial": modalidade.get("presencial"),
                        "totalModalidade": modalidade.get("totalModalidade"),

                        # ğŸ”¹ Totais gerais de despesa
                        "despesaTotalEad": data.get("depesaTotalEad"),
                        "despesaTotalPresencial": data.get("depesaTotalPresencial"),
                        "despesaTotalGeral": data.get("depesaTotalGeral"),

                        # ğŸ”¹ Extras
                        "dataPublicacao": data.get("dataPublicacao"),
                        "fonte": data.get("fonte"),
                        "nota": data.get("nota"),
                        "periodoReferencia": data.get("periodoReferencia"),
                    })

        except Exception as e:
            print(f"âš ï¸ Erro em {dep} - {ano}: {e}")

# ğŸ”¹ Criar DataFrame
df = pd.DataFrame(dados)

# ğŸ”¹ Ordenar para organizar
df.sort_values(by=["departamento", "ano"], inplace=True)

# ğŸ”¹ Salvar Excel
df.to_excel("SENAI_Despesas_Gratuidade_Regimental.xlsx", index=False)

print(f"âœ… ConcluÃ­do! Total de linhas extraÃ­das: {len(df)}")
print("ğŸ“ Arquivo salvo como: SENAI_Despesas_Gratuidade_Regimental.xlsx")
